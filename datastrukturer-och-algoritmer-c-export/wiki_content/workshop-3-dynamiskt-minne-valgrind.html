<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Workshop 3 - Dynamiskt minne, Valgrind</title>
<meta name="identifier" content="g135424dc2c1590f3e428d6eb3ec3b5b0"/>
<meta name="editing_roles" content="teachers"/>
<meta name="workflow_state" content="active"/>
</head>
<body>

<div id="outline-container-org414dc24" class="outline-2">
<h2 id="org414dc24">Syftet med Workshop 3</h2>
<div class="outline-text-2" id="text-org414dc24">
<ul class="org-ul">
<li>Att introducera verktyget <code>valgrind</code> för att hitta minnesläckor i
koden.</li>
<li>Erfarenheten är att <code>valgrind</code> är ett nödvändigt verktyg för att
skriva kod utan minnesluckor.</li>
<li>Vi rekommenderar att ni även kör koden ni genererar nedan i en
debugger. Se Workshop 1 och 2 för instruktioner.</li>
<li>Försök först lösa övningen själv! Sedan är du välkommen att
tjuvtitta på <a href="$WIKI_REFERENCE$/pages/ge6467154fb51f22664ebcf9a61124898">lösningsförslaget</a> innan du går vidare till nästa
övning.</li>
</ul>
</div>
</div>

<div id="outline-container-org21e67f6" class="outline-2">
<h2 id="org21e67f6">Förutsättningar</h2>
<div class="outline-text-2" id="text-org21e67f6">
<ul class="org-ul">
<li>För denna workshop behöver ni kompilatorn <code>gcc</code> och programmet
<code>valgrind</code>.
<ul class="org-ul">
<li>OBS! All kompilering ska inkludera flaggan <code>-g</code> (debug) för att få
bästa hjälp av <code>valgrind</code>!</li>
</ul></li>
<li>Du behöver också kodbasen <code>v2.0</code> eller senare. Ladda ner den från
Filer/Datatypskod.</li>
<li>Du kan välja att köra lokalt på din dator (Linux och Windows/WSL2)
eller via <code>ssh=/=putty</code> till någon av datavetenskaps datorer.</li>
</ul>
</div>
</div>

<div id="outline-container-org020e8b8" class="outline-2">
<h2 id="org020e8b8"><span class="section-number-2">1.</span> Övning 1 - Grundläggande pekare och adresstilldelning.</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Börja med att skapa två grundvariabler <code>i1</code> och <code>i2</code> av typen <code>int</code>
samt två grundvariabler <code>c1</code> och <code>c2</code> av typen <code>char</code>.</li>
<li>Skapa en pekare <code>ip</code> till <code>int</code> och <code>cp</code> till <code>char</code>.</li>
<li>Sätt respektive pekare att peka på den första grundvariabeln av
respektive typ.</li>
<li>Tilldela de första grundvariablerna relevanta värden <b>via pekarna</b>.</li>
<li>Skriv ut grundvariablernas värden (<b>inte</b> via pekarna).</li>
<li>Sätt om pekarna till <b>den andra</b> grundvariabeln av rätt typ.</li>
<li>Tilldela de andra grundvariablerna relevanta värden direkt (<b>inte</b> via pekarna).</li>
<li>Skriv ut grundvariablernas värden <b>via</b> pekarna och kontrollera att
den har rätt värde.</li>
</ol>
</div>
</div>

<div id="outline-container-org539638c" class="outline-2">
<h2 id="org539638c"><span class="section-number-2">2.</span> Övning 2 - Pekare till en <code>struct</code></h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li>Skapa en struct som heter <code>struct point3d</code> och innehåller 3 heltal <code>x</code>, <code>y</code>, <code>z</code>!
<ol class="org-ol">
<li>Använd <code>typedef</code> för döpa typen <code>struct point3d</code> till
<code>special_point</code>.</li>
</ol></li>
<li>Skapa en variabel av typen <code>special_point</code>, t.ex. <code>special_point pt;</code>.</li>
<li>Lägg in lämpliga värden på koordinaterna.
<ol class="org-ol">
<li>För att komma åt fältena <code>x</code>, <code>y</code> och <code>z</code> i variabeln <code>pt</code>
så skriver du <code>pt.x</code>, <code>pt.y</code> resp. <code>pt.z</code>.</li>
</ol></li>
<li>Skapa en <b>pekare</b> <code>q</code> till <code>pt</code>.</li>
<li>Skriv ut de tre koordinaterna i <code>pt</code> <b>via</b> pekaren <code>q</code>
<ol class="org-ol">
<li>För att komma åt fälten via en pekare använder man <code>-&gt;</code>-operatorn.</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-orge5144c5" class="outline-2">
<h2 id="orge5144c5"><span class="section-number-2">3.</span> Övning 3 - Fält av pekare</h2>
<div class="outline-text-2" id="text-3">
<ol class="org-ol">
<li>Skapa ett statiskt fält <code>i</code> som rymmer 5 heltal. Initiera fältet till 1, 2, …, 5.</li>
<li>Skapa ett statiskt fält <code>p</code> med 5 <b>pekare</b> till heltal. Hur skriver
man detta?</li>
<li>Skriv en loop som sätter de 5 pekarna så de pekar på 5 heltalen.</li>
<li>Skriv en loop som skriver ut värderna på heltalen via pekarna
(<b>dereferering</b>).</li>
</ol>
</div>
</div>

<div id="outline-container-org3fd08ed" class="outline-2">
<h2 id="org3fd08ed"><span class="section-number-2">4.</span> Övning 4 - Dynamiskt fält</h2>
<div class="outline-text-2" id="text-4">
<p>
Nu ska vi göra koden i övning 3 lite mer flexibel.
</p>

<ol class="org-ol">
<li>Läs in ett heltal <code>n</code> med <code>scanf</code>.</li>
<li>Skapa ett dynamiskt fält <code>p</code> som rymmer <code>n</code> heltal med <code>malloc()</code></li>
<li>Skriv en loop som fyller fältet med heltal med anrop till <code>scanf</code>.</li>
<li>Skriv en loop som skriver ut alla heltalen i fältet.</li>
<li>Avallokera det dynamiska minnet med <code>free</code>.</li>
</ol>
</div>

<div id="outline-container-org4f851f5" class="outline-3">
<h3 id="org4f851f5"><span class="section-number-3">4.1.</span> Övning 4.1 - Hitta minnesfel med <code>valgrind</code></h3>
<div class="outline-text-3" id="text-4-1">
<ol class="org-ol">
<li>Kommentera bort anropet till <code>free</code> och kompilera om.</li>
<li>Kör programmet. Notera att du får ingen återkoppling om att du har
en minnesläcka.</li>
<li>Kör programmet med hjälp av <code>valgrind</code>
<ul class="org-ul">
<li><p>
Använd kommandoraden
</p>
<div class="org-src-container">
<pre class="src src-bash">valgrind --leak-check=full --show-reachable=yes ./ws34
</pre>
</div>
<p>
där <code>ws34</code> är namnet på din körbara fil.
</p></li>
<li><p>
Om <code>valgrind</code> inte är installerat, installera det med
</p>
<div class="org-src-container">
<pre class="src src-bash">sudo snap install valgrind --classic
</pre>
</div>
<p>
eller
</p>
<div class="org-src-container">
<pre class="src src-bash">sudo apt install valgrind
</pre>
</div></li>
<li><p>
Ni bör få en utskrift liknande denna:
</p>
<pre class="example" id="orgd34c5fd">==152481== Memcheck, a memory error detector
==152481== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==152481== Using Valgrind-3.20.0 and LibVEX; rerun with -h for copyright info
==152481== Command: ./ws34
==152481== 
Enter n: 3
Enter number 0: 2
Enter number 1: 6
Enter number 2: 4
Number 0: 2
Number 1: 6
Number 2: 4
==152481== 
==152481== HEAP SUMMARY:
==152481==     in use at exit: 12 bytes in 1 blocks
==152481==   total heap usage: 3 allocs, 2 frees, 2,060 bytes allocated
==152481== 
==152481== 12 bytes in 1 blocks are definitely lost in loss record 1 of 1
==152481==    at 0x4A390C5: malloc (vg_replace_malloc.c:393)
==152481==    by 0x109204: main (ws34.c:12)
==152481== 
==152481== LEAK SUMMARY:
==152481==    definitely lost: 12 bytes in 1 blocks
==152481==    indirectly lost: 0 bytes in 0 blocks
==152481==      possibly lost: 0 bytes in 0 blocks
==152481==    still reachable: 0 bytes in 0 blocks
==152481==         suppressed: 0 bytes in 0 blocks
==152481== 
==152481== For lists of detected and suppressed errors, rerun with: -s
==152481== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)
</pre></li>
<li>Notera referensen <code>main (ws34.c:12)</code> som betyder rad 12 i
funktionen <code>main()</code> i filen <code>ws34.c</code> (eller vad du nu kallat din
källkodsfil). Vad betyder det?</li>
</ul></li>
<li>Återställ anropet till <code>free()</code> och kompilera om.</li>
<li><p>
Kör programmet igen med <code>valgrind</code>.
</p>
<pre class="example" id="orgdb8ce46">==153758== Memcheck, a memory error detector
==153758== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==153758== Using Valgrind-3.20.0 and LibVEX; rerun with -h for copyright info
==153758== Command: ./ws34
==153758== 
Enter n: 3
Enter number 0: 7
Enter number 1: 9
Enter number 2: 33
Number 0: 7
Number 1: 9
Number 2: 33
==153758== 
==153758== HEAP SUMMARY:
==153758==     in use at exit: 0 bytes in 0 blocks
==153758==   total heap usage: 3 allocs, 3 frees, 2,060 bytes allocated
==153758== 
==153758== All heap blocks were freed -- no leaks are possible
==153758== 
==153758== For lists of detected and suppressed errors, rerun with: -s
==153758== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
<ul class="org-ul">
<li>Notera att <code>valgrind</code> nu är nöjd: <code>All heap blocks were freed -- no leaks are possible</code>.</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orge9a2f8b" class="outline-2">
<h2 id="orge9a2f8b"><span class="section-number-2">5.</span> Övning 5 - Dynamiskt fält med pekare</h2>
<div class="outline-text-2" id="text-5">
<ol class="org-ol">
<li>Läs in ett heltal <code>n</code> med <code>scanf</code>.</li>
<li>Skapa ett dynamiskt fält <code>p</code> av pekare till <code>n</code> stycken
3d-koordinater som använder den struktur du gjorde i övningen
tidigare.</li>
<li>Allokera minne dynamiskt till var och en av de <code>n</code> punkterna och
sätt koordinaterna till vilka värden du vill.</li>
<li>Loopa igenom och skriv ut alla koordinater.</li>
<li>Se till att avallokera koordinaterna och fältet med pekare <code>p</code>.</li>
</ol>
</div>

<div id="outline-container-orgd5ae74c" class="outline-3">
<h3 id="orgd5ae74c"><span class="section-number-3">5.1.</span> Övning 5.1 - Hitta minnesfel med <code>valgrind</code></h3>
<div class="outline-text-3" id="text-5-1">
<ol class="org-ol">
<li>Kommentera bort bägge anropen till <code>free</code> och kompilera om.</li>
<li>Kör programmet. Notera att du får ingen återkoppling om att du har
en minnesläcka.</li>
<li>Kör programmet med hjälp av <code>valgrind</code>
<ul class="org-ul">
<li><p>
Använd kommandoraden
</p>
<div class="org-src-container">
<pre class="src src-bash">valgrind --leak-check=full --show-reachable=yes ./ws35
</pre>
</div>
<p>
där <code>ws35</code> är namnet på din körbara fil.
</p></li>
<li><p>
Ni bör få en utskrift liknande denna:
</p>
<pre class="example" id="org1014ba2">==169514== Memcheck, a memory error detector
==169514== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==169514== Using Valgrind-3.20.0 and LibVEX; rerun with -h for copyright info
==169514== Command: ./ws35
==169514== 
Enter the number of points: 3
Pt 0 = (3, 4, 5)
Pt 1 = (13, 14, 15)
Pt 2 = (23, 24, 25)
==169514== 
==169514== HEAP SUMMARY:
==169514==     in use at exit: 60 bytes in 4 blocks
==169514==   total heap usage: 6 allocs, 2 frees, 2,108 bytes allocated
==169514== 
==169514== 36 bytes in 3 blocks are indirectly lost in loss record 1 of 2
==169514==    at 0x4A390C5: malloc (vg_replace_malloc.c:393)
==169514==    by 0x10923E: main (ws35.c:25)
==169514== 
==169514== 60 (24 direct, 36 indirect) bytes in 1 blocks are definitely lost in loss record 2 of 2
==169514==    at 0x4A390C5: malloc (vg_replace_malloc.c:393)
==169514==    by 0x1091FE: main (ws35.c:17)
==169514== 
==169514== LEAK SUMMARY:
==169514==    definitely lost: 24 bytes in 1 blocks
==169514==    indirectly lost: 36 bytes in 3 blocks
==169514==      possibly lost: 0 bytes in 0 blocks
==169514==    still reachable: 0 bytes in 0 blocks
==169514==         suppressed: 0 bytes in 0 blocks
==169514== 
==169514== For lists of detected and suppressed errors, rerun with: -s
==169514== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)
</pre></li>
<li><p>
Notera blocket
</p>
<pre class="example" id="orgad890b5">==169514== 36 bytes in 3 blocks are indirectly lost in loss record 1 of 2
==169514==    at 0x4A390C5: malloc (vg_replace_malloc.c:393)
==169514==    by 0x10923E: main (ws35.c:25)
</pre>
<ul class="org-ul">
<li>Vad betyder det?</li>
</ul></li>
<li><p>
Notera blocket
</p>
<pre class="example" id="orga3ef6b2">==169514== 60 (24 direct, 36 indirect) bytes in 1 blocks are definitely lost in loss record 2 of 2
==169514==    at 0x4A390C5: malloc (vg_replace_malloc.c:393)
==169514==    by 0x1091FE: main (ws35.c:17)
</pre>
<ul class="org-ul">
<li>Vad betyder det?</li>
</ul></li>
</ul></li>
<li>Återställ anropen till <code>free()</code> och kompilera om.</li>
<li><p>
Kör programmet igen med <code>valgrind</code>.
</p>
<pre class="example" id="org51ab8cf">==169937== Memcheck, a memory error detector
==169937== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==169937== Using Valgrind-3.20.0 and LibVEX; rerun with -h for copyright info
==169937== Command: ./ws35
==169937== 
Enter the number of points: 3
Pt 0 = (3, 4, 5)
Pt 1 = (13, 14, 15)
Pt 2 = (23, 24, 25)
==169937== 
==169937== HEAP SUMMARY:
==169937==     in use at exit: 0 bytes in 0 blocks
==169937==   total heap usage: 6 allocs, 6 frees, 2,108 bytes allocated
==169937== 
==169937== All heap blocks were freed -- no leaks are possible
==169937== 
==169937== For lists of detected and suppressed errors, rerun with: -s
==169937== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre>
<ul class="org-ul">
<li>Notera att <code>valgrind</code> nu är nöjd: <code>All heap blocks were freed -- no leaks are possible</code>.</li>
</ul></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orge391299" class="outline-2">
<h2 id="orge391299"><span class="section-number-2">6.</span> Övning 6 — kodbasen</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org5216a2f" class="outline-3">
<h3 id="org5216a2f"><span class="section-number-3">6.1.</span> Övning 6.1 — <code>list_mwe2.c</code></h3>
<div class="outline-text-3" id="text-6-1">
<p>
I denna övning ska du kompilera ett exempel från kodbasen som är
designat att använda en s.k. <code>kill_function</code> och vad som kan gå fel.
</p>

<ol class="org-ol">
<li><p>
Kopiera filen <code>list_mwe2.c</code> från <code>.../src/list</code> till en egen katalog.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdio.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdlib.h&gt;</span>

<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;list.h&gt;</span>

<span style="color: #b22222;">/*</span>
<span style="color: #b22222;"> * Minimum working example for list.c.</span>
<span style="color: #b22222;"> *</span>
<span style="color: #b22222;"> * Authors: Niclas Borlin (niclas@cs.umu.se)</span>
<span style="color: #b22222;"> *          Adam Dahlgren Lindstrom (dali@cs.umu.se)</span>
<span style="color: #b22222;"> *</span>
<span style="color: #b22222;"> * Version information:</span>
<span style="color: #b22222;"> *   v1.0  2018-01-28: First public version.</span>
<span style="color: #b22222;"> *   v1.1  2018-04-03: Split into versions with/without memhandler.</span>
<span style="color: #b22222;"> *   v1.2  2023-01-14: Added printouts at start/end of main.</span>
<span style="color: #b22222;"> *   v1.21 2024-01-16: Fix include to be with brackets, not citation marks.</span>
<span style="color: #b22222;"> *   v1.3  2024-03-13: Added explicit create/kill functions.</span>
<span style="color: #b22222;"> */</span>

<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">VERSION</span> <span style="color: #8b2252;">"v1.3"</span>
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">VERSION_DATE</span> <span style="color: #8b2252;">"2024-03-13"</span>

<span style="color: #b22222;">// </span><span style="color: #b22222;">Integers are stored via int pointers stored as void pointers.</span>
<span style="color: #b22222;">// </span><span style="color: #b22222;">Convert the given pointer and print the dereferenced value.</span>
<span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">print_int</span>(<span style="color: #a020f0;">const</span> <span style="color: #228b22;">void</span> *<span style="color: #a0522d;">data</span>)
{
    <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">v</span> = data;
    printf(<span style="color: #8b2252;">"%d"</span>, *v);
}

<span style="color: #b22222;">// </span><span style="color: #b22222;">Create a dynamic copy of the integer i.</span>
<span style="color: #228b22;">int</span> *<span style="color: #0000ff;">int_create</span>(<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>)
{
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Allocate memory for an integer and set the value</span>
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">v</span>=malloc(<span style="color: #a020f0;">sizeof</span>(*v));
    *v = i;
    <span style="color: #a020f0;">return</span> v;
}

<span style="color: #b22222;">// </span><span style="color: #b22222;">Return the memory used by the integer.</span>
<span style="color: #228b22;">void</span> <span style="color: #0000ff;">int_kill</span>(<span style="color: #228b22;">void</span> *<span style="color: #a0522d;">v</span>)
{
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">p</span>=v;
    free(p);
}

<span style="color: #228b22;">int</span> <span style="color: #0000ff;">main</span>(<span style="color: #228b22;">void</span>)
{
    printf(<span style="color: #8b2252;">"%s, %s %s: Create integer list with custom kill_function.\n"</span>,
           __FILE__, VERSION, VERSION_DATE);
    printf(<span style="color: #8b2252;">"Code base version %s.\n\n"</span>, CODE_BASE_VERSION);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Create the list.</span>
    <span style="color: #228b22;">list</span> *<span style="color: #a0522d;">l</span> = list_empty(int_kill);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Create a dynamic integer with value 5.</span>
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">val</span> = int_create(5);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Insert the value first in the list.</span>
    list_insert(l, val, list_first(l));

    printf(<span style="color: #8b2252;">"List after inserting one value:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Allocate space for another integer.</span>
    val = int_create(8);
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Insert the value last in the list.</span>
    list_insert(l, val, list_end(l));

    printf(<span style="color: #8b2252;">"List after inserting second value at the end:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Allocate space for a third integer.</span>
    val = int_create(2);
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Insert the value at the second position in the list.</span>
    list_insert(l, val, list_next(l, list_first(l)));

    printf(<span style="color: #8b2252;">"List after inserting a third value in the middle:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Remove first element.</span>
    list_remove(l, list_first(l));

    printf(<span style="color: #8b2252;">"List after removing first element:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Done, kill the list.</span>
    list_kill(l);

    printf(<span style="color: #8b2252;">"\nNormal exit.\n\n"</span>);
    <span style="color: #a020f0;">return</span> 0;
}
</pre>
</div></li>
<li><p>
Notera följande rad:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">list</span> *<span style="color: #a0522d;">l</span> = list_empty(int_kill);
</pre>
</div>
<ul class="org-ul">
<li>Parametern <code>int_kill</code> betyder att listan övertar ansvaret för att
avallokera alla elementvärden som stoppas in i listan.</li>
<li>När ett element ska tas bort i listan (av <code>list_remove()</code>
och/eller <code>list_kill()</code>) så ska list-funktionerna anropa
funktionen <code>int_kill()</code> för att avallokera <b>elementvärdet</b>,
dvs. pekare du stoppade in i listan med <code>list_insert()</code>.</li>
<li>Fördelen med denna lösning är att du slipper ''städa upp'' när
listan är färdiganvänd.</li>
</ul></li>
<li>Kompilera programmet med <code>-g</code> och kör programmet. Allt bör se bra
ut.</li>
<li>Kör programmet med <code>valgrind</code>. Du bör inte få några felmeddelanden.</li>
<li>Byt nu ut parametern <code>int_kill</code> mot <code>NULL</code> och kompilera om
programmet. Du har nu introducerat en minnesläcka då varken listan
eller huvudprogrammet avallokerar elementvärdena.</li>
<li>Kör programmet. Allt bör se ut som förut. Minnesläckan syns inte i
utskrifterna.</li>
<li>Kör programmet med <code>valgrind</code>. Notera utskrifterna. Vilka sorters
fel får du? Lägg dessa utskrifter på minnet då du kan få denna typ
av fel om du glömmer att avallokera elementvärden.</li>
</ol>
</div>
</div>

<div id="outline-container-orgc321778" class="outline-3">
<h3 id="orgc321778"><span class="section-number-3">6.2.</span> Övning 6.2 — <code>list_mwe1.c</code></h3>
<div class="outline-text-3" id="text-6-2">
<p>
I denna övning ska du kompilera ett exempel från kodbasen som är
designat att <b>inte</b> använda en s.k. <code>kill_function</code> och vad som kan gå fel.
</p>

<ol class="org-ol">
<li><p>
Kopiera filen <code>list_mwe1.c</code> från <code>.../src/list</code> till en egen katalog.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdio.h&gt;</span>
<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;stdlib.h&gt;</span>

<span style="color: #483d8b;">#include</span> <span style="color: #8b2252;">&lt;list.h&gt;</span>

<span style="color: #b22222;">/*</span>
<span style="color: #b22222;"> * Minimum working example for list.c.</span>
<span style="color: #b22222;"> *</span>
<span style="color: #b22222;"> * Authors: Niclas Borlin (niclas@cs.umu.se)</span>
<span style="color: #b22222;"> *          Adam Dahlgren Lindstrom (dali@cs.umu.se)</span>
<span style="color: #b22222;"> *</span>
<span style="color: #b22222;"> * Version information:</span>
<span style="color: #b22222;"> *   v1.0 2018-01-28: First public version.</span>
<span style="color: #b22222;"> *   v1.1 2018-04-03: Split into versions with/without memhandler.</span>
<span style="color: #b22222;"> *   v1.2 2023-01-14: Added printouts at start/end of main.</span>
<span style="color: #b22222;"> *   v1.3 2024-03-13: Added explicit create/kill functions.</span>
<span style="color: #b22222;"> */</span>

<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">VERSION</span> <span style="color: #8b2252;">"v1.3"</span>
<span style="color: #483d8b;">#define</span> <span style="color: #a0522d;">VERSION_DATE</span> <span style="color: #8b2252;">"2024-03-13"</span>

<span style="color: #b22222;">// </span><span style="color: #b22222;">Integers are stored via int pointers stored as void pointers.</span>
<span style="color: #b22222;">// </span><span style="color: #b22222;">Convert the given pointer and print the dereferenced value.</span>
<span style="color: #a020f0;">static</span> <span style="color: #228b22;">void</span> <span style="color: #0000ff;">print_int</span>(<span style="color: #a020f0;">const</span> <span style="color: #228b22;">void</span> *<span style="color: #a0522d;">data</span>)
{
    <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">v</span> = data;
    printf(<span style="color: #8b2252;">"%d"</span>, *v);
}

<span style="color: #b22222;">// </span><span style="color: #b22222;">Create a dynamic copy of the integer i.</span>
<span style="color: #228b22;">int</span> *<span style="color: #0000ff;">int_create</span>(<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>)
{
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Allocate memory for an integer and set the value</span>
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">v</span>=malloc(<span style="color: #a020f0;">sizeof</span>(*v));
    *v = i;
    <span style="color: #a020f0;">return</span> v;
}

<span style="color: #b22222;">// </span><span style="color: #b22222;">Return the memory used by the integer.</span>
<span style="color: #228b22;">void</span> <span style="color: #0000ff;">int_kill</span>(<span style="color: #228b22;">void</span> *<span style="color: #a0522d;">v</span>)
{
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">p</span>=v;
    free(p);
}

<span style="color: #228b22;">int</span> <span style="color: #0000ff;">main</span>(<span style="color: #228b22;">void</span>)
{
    printf(<span style="color: #8b2252;">"%s, %s %s: Create integer list without kill_function.\n"</span>,
           __FILE__, VERSION, VERSION_DATE);
    printf(<span style="color: #8b2252;">"Code base version %s.\n\n"</span>, CODE_BASE_VERSION);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Create the list.</span>
    <span style="color: #228b22;">list</span> *<span style="color: #a0522d;">l</span> = list_empty(<span style="color: #008b8b;">NULL</span>);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Create a dynamic integer with value 5.</span>
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">val</span> = int_create(5);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Insert the value first in the list.</span>
    list_insert(l, val, list_first(l));

    printf(<span style="color: #8b2252;">"List after inserting one value:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Allocate space for another integer.</span>
    val = int_create(8);
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Insert the value last in the list.</span>
    list_insert(l, val, list_end(l));

    printf(<span style="color: #8b2252;">"List after inserting second value at the end:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Allocate space for a third integer.</span>
    val = int_create(2);
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Insert the value at the second position in the list.</span>
    list_insert(l, val, list_next(l, list_first(l)));

    printf(<span style="color: #8b2252;">"List after inserting a third value in the middle:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Remove first element.</span>
    <span style="color: #228b22;">list_pos</span> <span style="color: #a0522d;">p</span>=list_first(l);
    <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">v</span>=list_inspect(l, p);
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Remove element from list.</span>
    list_remove(l, p);
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Free element content.</span>
    int_kill(v);

    printf(<span style="color: #8b2252;">"List after removing first element:\n"</span>);
    list_print(l, print_int);

    <span style="color: #b22222;">// </span><span style="color: #b22222;">Empty the list.</span>
    <span style="color: #a020f0;">while</span> (!list_is_empty(l)) {
        <span style="color: #228b22;">list_pos</span> <span style="color: #a0522d;">p</span>=list_first(l);
        <span style="color: #228b22;">int</span> *<span style="color: #a0522d;">v</span>=list_inspect(l,p);
        int_kill(v);
        list_remove(l,p);
    }
    <span style="color: #b22222;">// </span><span style="color: #b22222;">Done, kill the list.</span>
    list_kill(l);

    printf(<span style="color: #8b2252;">"\nNormal exit.\n\n"</span>);
    <span style="color: #a020f0;">return</span> 0;
}
</pre>
</div></li>
<li><p>
Notera följande rad:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">list</span> *<span style="color: #a0522d;">l</span> = list_empty(<span style="color: #008b8b;">NULL</span>);
</pre>
</div>
<ul class="org-ul">
<li>Parametern <code>NULL</code> betyder att du behåller ansvaret för att
avallokera alla elementvärden som stoppas in i listan.</li>
<li>Fördelen med denna lösning är att du har lite större frihet att
flytta runt element utan att elementvärdena avallokeras.</li>
<li>Det ger dig också friheten att lagra <b>samma</b> elementvärden i
<b>olika</b> datatyper, där exakt <b>en</b> av datatyperna får ansvaret för
att avallokera elementvärdena.</li>
</ul></li>
<li>Notera också den avslutande loopen i huvudprogrammet (under <code>//
   Empty the list</code>). Den avallokerar varje kvarvarande elementvärde
innan listan dödas med <code>list_kill()</code>.</li>
<li>Kompilera programmet med <code>-g</code> och kör programmet. Allt bör se bra
ut.</li>
<li>Kör programmet med <code>valgrind</code>. Du bör inte få några felmeddelanden.</li>
<li>Byt nu ut parametern <code>NULL</code> mot <code>int_kill</code> och kompilera om
programmet. Du har nu introducerat en bug då två delar av
programmet kommer att försöka avallokera elementvärdena — din
avslutande loop och koden i <code>list_kill()</code>.</li>
<li>Kör programmet. För du några indikationer på att något är fel?</li>
<li>Kör programmet med <code>valgrind</code>. Notera utskrifterna. Vilka sorters
fel får du? Lägg dessa utskrifter på minnet då du kan få denna typ
av fel om du glömmer att avallokera elementvärden.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgb8e4ef6" class="outline-2">
<h2 id="orgb8e4ef6"><span class="section-number-2">7.</span> Övning 7 — hitta minnesfel i annans kod</h2>
<div class="outline-text-2" id="text-7">
<ol class="org-ol">
<li>För denna övning, ladda hem programmet <code>bug4.c</code> som du hittar under
Filer/Workshops/WS3.</li>
<li>Kompilera koden. Kom ihåg att inkludera flaggan <code>-g</code>.</li>
<li>Kör koden med valgrind som beskrivs ovan. Se om du kan upptäcka och
fixa buggarna!</li>
<li>Du får också köra koden i debuggern om du vill.</li>
<li>Lösning finns i <code>Filer/Workshop/WS3/korrekt kod</code>.</li>
</ol>
</div>
</div>

</body>
</html>